<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="RocketMQ," />





  <link rel="alternate" href="/atom.xml" title="flbu blog" type="application/atom+xml" />






<meta name="description" content="消息队列学习笔记–RocketMQ消息队列的优缺点优点异步对于实时性不是很高的业务，如积分增减、发送短信等非核心流程，可以放到消息队列中去，提升整个链路的响应时间。 削峰填谷对于秒杀等短时间大流量场景，可以将请求短暂的在消息队列中堆积，平滑的消费请求。 解耦MQ可以实现服务的高内聚、低耦合，通过发布订阅模型实现系统&#x2F;模块间的解耦。 缺点系统可用性降低MQ相当于一个依赖组件，一旦出问题会导致系统不可">
<meta name="keywords" content="RocketMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ原理学习">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2022&#x2F;05&#x2F;17&#x2F;RocketMQ%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0&#x2F;index.html">
<meta property="og:site_name" content="flbu blog">
<meta property="og:description" content="消息队列学习笔记–RocketMQ消息队列的优缺点优点异步对于实时性不是很高的业务，如积分增减、发送短信等非核心流程，可以放到消息队列中去，提升整个链路的响应时间。 削峰填谷对于秒杀等短时间大流量场景，可以将请求短暂的在消息队列中堆积，平滑的消费请求。 解耦MQ可以实现服务的高内聚、低耦合，通过发布订阅模型实现系统&#x2F;模块间的解耦。 缺点系统可用性降低MQ相当于一个依赖组件，一旦出问题会导致系统不可">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https:&#x2F;&#x2F;bytedance.feishu.cn&#x2F;space&#x2F;api&#x2F;box&#x2F;stream&#x2F;download&#x2F;asynccode&#x2F;?code=YWQyMGIyZTEzNzNmNmVjMDFlMmFiYjBlNjEyMDZhYTlfSm12ZlNueHp5UFBtcDlTR1JvWnVyT01zSFY3RDhENlZfVG9rZW46Ym94Y240WkdydTI0TDJhM1BvUkhtNkNxSzhmXzE2MjY1MDA0NjQ6MTYyNjUwNDA2NF9WNA">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;bu_fei_long&#x2F;picBed&#x2F;raw&#x2F;master&#x2F;images&#x2F;RocketMQ%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg">
<meta property="og:image" content="d:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.jpg">
<meta property="og:image" content="d:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;bu_fei_long&#x2F;picBed&#x2F;raw&#x2F;master&#x2F;images&#x2F;RocketMQ%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95.jpg">
<meta property="og:image" content="d:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E6%B6%88%E8%B4%B9%E9%A1%BA%E5%BA%8F%E6%80%A7.jpg">
<meta property="og:updated_time" content="2022-05-17T14:50:51.136Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;bytedance.feishu.cn&#x2F;space&#x2F;api&#x2F;box&#x2F;stream&#x2F;download&#x2F;asynccode&#x2F;?code=YWQyMGIyZTEzNzNmNmVjMDFlMmFiYjBlNjEyMDZhYTlfSm12ZlNueHp5UFBtcDlTR1JvWnVyT01zSFY3RDhENlZfVG9rZW46Ym94Y240WkdydTI0TDJhM1BvUkhtNkNxSzhmXzE2MjY1MDA0NjQ6MTYyNjUwNDA2NF9WNA">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2022/05/17/RocketMQ原理学习/"/>





  <title>RocketMQ原理学习 | flbu blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/f1bu920" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">flbu blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习历程</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tag"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" target="_blank" rel="noopener" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/17/RocketMQ%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flbu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="flbu blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RocketMQ原理学习</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-05-17T22:48:46+08:00">
                2022-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">消息队列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="消息队列学习笔记–RocketMQ"><a href="#消息队列学习笔记–RocketMQ" class="headerlink" title="消息队列学习笔记–RocketMQ"></a>消息队列学习笔记–RocketMQ</h1><h2 id="消息队列的优缺点"><a href="#消息队列的优缺点" class="headerlink" title="消息队列的优缺点"></a>消息队列的优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><h4 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h4><p>对于实时性不是很高的业务，如积分增减、发送短信等非核心流程，可以放到消息队列中去，提升整个链路的响应时间。</p>
<h4 id="削峰填谷"><a href="#削峰填谷" class="headerlink" title="削峰填谷"></a>削峰填谷</h4><p>对于秒杀等短时间大流量场景，可以将请求短暂的在消息队列中堆积，平滑的消费请求。</p>
<h4 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h4><p>MQ可以实现服务的高内聚、低耦合，通过发布订阅模型实现系统/模块间的解耦。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><h4 id="系统可用性降低"><a href="#系统可用性降低" class="headerlink" title="系统可用性降低"></a>系统可用性降低</h4><p>MQ相当于一个依赖组件，一旦出问题会导致系统不可用。</p>
<h4 id="系统复杂度提高"><a href="#系统复杂度提高" class="headerlink" title="系统复杂度提高"></a>系统复杂度提高</h4><p>引入MQ如何保证消息不重复消费？如何处理消息丢失？如何保证消息的顺序消费？</p>
<h4 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h4><p>生产者消费者事务执行结果不一致造成的数据不一致问题。</p>
<a id="more"></a>

<h2 id="消息队列选型"><a href="#消息队列选型" class="headerlink" title="消息队列选型"></a>消息队列选型</h2><p>ActiveMQ、RabbitMQ、RocketMQ、Kafka对比：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>单机吞吐量</td>
<td>万级，比 RocketMQ、Kafka 低一个数量级</td>
<td>同 ActiveMQ</td>
<td>10 万级，支撑高吞吐</td>
<td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td>
</tr>
<tr>
<td>topic 数量对吞吐量的影响</td>
<td></td>
<td></td>
<td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td>
<td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td>
</tr>
<tr>
<td>时效性</td>
<td>ms 级</td>
<td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td>
<td>ms 级</td>
<td>延迟在 ms 级以内</td>
</tr>
<tr>
<td>可用性</td>
<td>高，基于主从架构实现高可用</td>
<td>同 ActiveMQ</td>
<td>非常高，分布式架构</td>
<td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td>
</tr>
<tr>
<td>消息可靠性</td>
<td>有较低的概率丢失数据</td>
<td>基本不丢</td>
<td>经过参数优化配置，可以做到 0 丢失</td>
<td>同 RocketMQ</td>
</tr>
<tr>
<td>功能支持</td>
<td>MQ 领域的功能极其完备</td>
<td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td>
<td>MQ 功能较为完善，还是分布式的，扩展性好</td>
<td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td>
</tr>
</tbody></table>
<p>ActiveMQ：因为使用公司较少，没有经过大规模吞吐场景的考验，社区也不活跃，所以不做讨论。</p>
<p>RabbitMQ：是ActiveMQ的替代方案，能够保证数据不丢失，但吞吐量只能到万级别，相比于Kafka和RocketMQ低了一个数量级，但比Kafka多了很多的高级特性，如消息重试和死信队列，且写入延迟能达到微秒级，但使用Erlang作为开发语言，较为劝退。</p>
<p>Kafka：单机吞吐量能达到10万级别，写入延迟能到毫秒级别，但功能较为简单，只支持简单的MQ功能，主要运用在大数据实时计算和日志收集领域。</p>
<p>RocketMQ：单机吞吐量能到10w级别，低延迟、高性能、高可用，并且功能丰富，像延时消息、事务消息、消息回溯、死信队列等，广泛应用在订单、交易、计算、消息推送、binlog分发等场景。</p>
<p>主要通过RocketMQ来学习消息队列。</p>
<h2 id="RocketMQ整体架构"><a href="#RocketMQ整体架构" class="headerlink" title="RocketMQ整体架构"></a>RocketMQ整体架构</h2><p><img src="https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQyMGIyZTEzNzNmNmVjMDFlMmFiYjBlNjEyMDZhYTlfSm12ZlNueHp5UFBtcDlTR1JvWnVyT01zSFY3RDhENlZfVG9rZW46Ym94Y240WkdydTI0TDJhM1BvUkhtNkNxSzhmXzE2MjY1MDA0NjQ6MTYyNjUwNDA2NF9WNA" alt="img"></p>
<p>RocketMQ主要分为四个组成部分：Producer、Broker、Consumer、Name Server。</p>
<p>其中，Producer负责生产消息，Consumer负责消费消息，Broker负责存储消息，NameServer负责注册发现与路由剔除。</p>
<h2 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h2><p>Topic 是一种逻辑上的分区，是同一类消息的集合，每一个消息只能属于一个 Topic ，是RocketMQ进行消息订阅的基本单位。</p>
<p>每个 topic 会被分成很多 Messsage Queue ，和 Kafka 中的 Partition 概念一样，topic 的数据被分布在不同的 Message Queue 中。</p>
<p>在业务增长，消息量增大时，可以增大 topic 的 Message Queue，这样可以将压力分摊到更多的 broker 上。因为 Producer 可以发送消息的时候可以通过指定的算法，将消息均匀的发送到每个 Message Queue，这种算法可以是轮询、随机选择、Hash，也可以是自定义的。</p>
<h2 id="NameServer"><a href="#NameServer" class="headerlink" title="NameServer"></a>NameServer</h2><p>NameServer的作用是注册中心，类似于Zookeeper。每个NameServer节点间互相独立，没有任何信息交互，不存在任何的选主或主从切换，因此比Zookeeper更加轻量。每个NameServer节点都保存了所有的Broker元数据，并和Broker保持长连接心跳。</p>
<p><img src="https://gitee.com/bu_fei_long/picBed/raw/master/images/RocketMQ%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt="img"></p>
<p>NameServer主要有两个功能：注册发现和路由剔除。</p>
<h3 id="注册发现"><a href="#注册发现" class="headerlink" title="注册发现"></a>注册发现</h3><p>Broker启动时会和NameServer所有的节点建立长连接，每隔30s发送一次心跳，包括BrokerId、Broker地址、Broker名称等Broker集群的信息和Topic的拓扑信息。然后生产者和消费者启动的时候任选一台 Name Server 机器拉取所需的 Topic 的路由信息缓存在本地内存中，之后每隔 30s 定时从远端拉取更新本地缓存。</p>
<h3 id="路由剔除"><a href="#路由剔除" class="headerlink" title="路由剔除"></a>路由剔除</h3><p>NameServer定期监测Broker的心跳，一旦超过120s没有最新的心跳，则判断Broker失联，关闭Broker连接，剔除Broker信息，但不会主动通知Producer和Consumer，需要主动拉取才会更新，所以最长需要30s才能感知到Broker故障。</p>
<h2 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h2><p>Producer负责生产消息，单个生产者与一台NameServer保持长链接，每隔30s从NameServer拉取topic配置信息，如果NameServer挂了，会自动连接另一台NameServer；单个生产者会和他关联的所有Broker保持长连接，并每隔30s发送心跳。</p>
<h3 id="消息发送方式"><a href="#消息发送方式" class="headerlink" title="消息发送方式"></a>消息发送方式</h3><h4 id="可靠同步发送"><a href="#可靠同步发送" class="headerlink" title="可靠同步发送"></a>可靠同步发送</h4><p>Producer发送消息后，需要收到接受方的响应才能发送下一条消息。</p>
<h4 id="可靠异步发送"><a href="#可靠异步发送" class="headerlink" title="可靠异步发送"></a>可靠异步发送</h4><p>异步发送是指发送方发出数据后，不等接收方发回响应，接着发送下个数据包的通讯方式。 MQ 的异步发送，需要用户实现异步发送回调接口（SendCallback）。消息发送方在发送了一条消息后，不需要等待服务器响应即可返回，进行第二条消息发送。发送方通过回调接口接收服务器响应，并对响应结果进行处理。</p>
<h4 id="单向发送"><a href="#单向发送" class="headerlink" title="单向发送"></a>单向发送</h4><p>送方只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求不等待应答。</p>
<h3 id="消息类型"><a href="#消息类型" class="headerlink" title="消息类型"></a>消息类型</h3><h4 id="普通消息"><a href="#普通消息" class="headerlink" title="普通消息"></a>普通消息</h4><p>即正常的消息</p>
<h4 id="延迟消息"><a href="#延迟消息" class="headerlink" title="延迟消息"></a>延迟消息</h4><p>延时消息在投递时，需要设置指定的延时级别，等到特定的时间间隔后消息才会被消费者消费。mq服务端，为每一个延迟级别单独设置一个定时器，定时(每隔1秒)拉取对应延迟级别的消费队列。</p>
<p>可以通过delayLevel设置延时级别，可以取以下值：1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h。</p>
<ul>
<li><p>level == 0，消息为非延迟消息</p>
</li>
<li><p>1&lt;=level&lt;=maxLevel，消息延迟特定时间，例如level==1，延迟1s</p>
</li>
<li><p>level &gt; maxLevel，则level== maxLevel，例如level==20，延迟2h</p>
</li>
</ul>
<h4 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h4><p>事务消息用于保证本地事务执行和MQ投递都能成功，保持一致性。</p>
<p>通过两阶段提交和状态定时回查来保证消息一定发送到Broker。</p>
<p><img src="D:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.jpg" alt="img"></p>
<p>Producer发送Half Message，服务端响应ACK写入结果，根据发送结果执行本地事务（如果写入失败，Half Message不可见，不执行本地事务），再根据本地事务的执行情况发送Commit/Rollback请求。</p>
<p>对于处于Half Message pending状态的消息，服务端会定期回查，Producer收到消息会检查本地事务的执行情况，根据本地事务状态重新Commit或Rollback。</p>
<p>注意：Half Message并未真正进入topic的queue，而是存放在临时queue中，提交事务后才会真正转移到topic的queue中。</p>
<h4 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h4><p>顺序消息分为全局顺序消息与分区顺序消息，全局顺序是指某个Topic下的所有消息都要保证顺序；部分顺序消息只要保证每一组消息被顺序消费即可。</p>
<ul>
<li><p>全局顺序 对于指定的一个 Topic，所有消息按照严格的先入先出（FIFO）的顺序进行发布和消费。 适用场景：性能要求不高，所有的消息严格按照 FIFO 原则进行消息发布和消费的场景。</p>
<ul>
<li>全局消息的实现方式：一个全局顺序 topic 只创建一个Message Queue</li>
</ul>
</li>
<li><p>分区顺序 对于指定的一个 Topic，所有消息根据  key 进行区块分区。 同一个分区内的消息按照严格的 FIFO 顺序进行发布和消费。  key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。 适用场景：性能要求高，以  key 作为分区字段，在同一个区块中严格的按照 FIFO 原则进行消息发布和消费的场景。</p>
</li>
</ul>
<h3 id="发送流程"><a href="#发送流程" class="headerlink" title="发送流程"></a>发送流程</h3><ol>
<li>Producer在发送消息的时候，如果本地路由表中未缓存Topic的路由信息，则向NameServer发送获取路由的请求，更新本地路由表，并每隔30s从NameServer更新本地路由表</li>
<li>Producer在拿到路由信息后，根据路由消息选择queue，发送消息</li>
</ol>
<p><img src="D:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B.jpg" alt="img"></p>
<h2 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h2><p>Consumer负责消费消息，一个消费者组可以订阅多个Topic。Consumer启动后，就会通过定时任务不断地向RocketMQ集群中的所有Broker实例保持长连接，并每隔30s发送心跳包（其中包含了，消息消费分组名称、订阅关系集合、消息通信模式和客户端id的值等信息），一旦连接断开，Broker会立即感知到，并向该消费者分组的所有消费者发出通知，分组内消费者重新分配队列继续消费。</p>
<p>单个消费者和一台nameserver保持长连接，定时查询topic配置信息，如果该nameserver挂掉，消费者会自动连接下一个nameserver，并且每隔30s会从NameServer拉取topic信息更新。</p>
<h4 id="消费模式"><a href="#消费模式" class="headerlink" title="消费模式"></a>消费模式</h4><ul>
<li><p>集群消费 同一个消费组里的消费者“瓜分”所有消息来消费，同一个消息只会被一个消费者实例消费。因为集群模式的消费进度是保存在Broker端的，所以即使应用崩溃，消费进度也不会出错。</p>
</li>
<li><p>广播消费 同一个消费组里的消费者会消费所有消息，即同一个消息会被每一个消费者实例消费。广播消费的消费进度保存在客户端机器的文件中。如果文件弄丢了，那么消费进度就丢失了，可能会导致部分消息没有消费。</p>
</li>
</ul>
<h4 id="拉取流程"><a href="#拉取流程" class="headerlink" title="拉取流程"></a>拉取流程</h4><p>对于任何一款消息中间件而言，消费者客户端一般有两种方式从消息中间件获取消息并消费：</p>
<p>（1）Push方式：由消息中间件主动地将消息推送给消费者；采用Push方式，实时性高，可以尽快的将消息发送给消费者进行消费。但是在消费者的处理消息的能力较弱的时候，而MQ不断地向消费者Push消息，消费者端的缓冲区可能会溢出，导致异常。</p>
<p>（2）Pull方式：由消费者客户端主动向消息中间件拉取消息；采用Pull方式，可控性好，如何设置Pull消息的频率需要重点去考虑。如果每次Pull的时间间隔比较久，会增加消息的延迟，若每次Pull的时间间隔较短，但是在一段时间内MQ中并没有任何消息可以消费，那么会产生很多无效的Pull请求的RPC开销，影响MQ整体的网络性能。</p>
<p><strong>RocketMQ的消费方式都是基于拉模式拉取消息的，而且还采用了一种长轮询机制</strong>，来平衡上面Push/Pull方式的各自缺点：</p>
<p><strong>Consumer发送pull请求，Broker端接受请求，如果发现队列里没有新消息，不立即返回，而是持有这个请求一段时间（通过设置超时时间来实现），在这段时间内轮询Broker队列内是否有新的消息，如果有新消息，就利用现有的连接返回消息给消费者；如果这段时间内没有新消息进入队列，则返回空。 这样消费消息的主动权既保留在Consumer端，也不会出现Broker积压大量消息后，短时间内推送给Consumer大量消息使Consumer因为性能问题出现消费不及时的情况。</strong></p>
<h4 id="消费进度保存"><a href="#消费进度保存" class="headerlink" title="消费进度保存"></a>消费进度保存</h4><p>集群消费模式中，消费进度保存在broker 上，而广播模式中保存在客户端本地。</p>
<p>消费进度是消费者组之间互相隔离的，Broker 上通过 Topic + 消费者组名称作为 key，value 中分别记录每个 MessageQueue 对应该消费者组的消费偏移量 offset。</p>
<p>消费者侧会记录自己的消费进度到内存中的 OffsetTable，然后定时提交到 Broker 侧。</p>
<p>由于一批消息的消费次序不确定，可能下标大的消息先被消费结束，下标小的由于延时尚未被消费，此时消费者向 Broker 提交的 offset 应该是已被消费的最小下标，从而保证消息不被遗漏，但缺点在于可能重复消费消息。</p>
<h4 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h4><ul>
<li>重试，死信 <strong>重试 Topic</strong>：如果由于各种意外导致消息消费失败，那么该消息会自动被保存到重试Topic中，格式为“%RETRY%消费者组”，在订阅的时候会自动订阅这个重试Topic。 进入重试队列的消息有16次重试机会，每次都会按照一定的时间间隔进行，只要正常消费或者重试消费中有一次消费成功，就算消费成功。 </li>
</ul>
<p><img src="https://gitee.com/bu_fei_long/picBed/raw/master/images/RocketMQ%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95.jpg" alt="img"></p>
<p> <strong>死信Topic</strong>：死信Topic名字格式为“%DLQ%消费者组名”。如果正常消费1次失败，重试16次失败，那么消息会被保存到死信Topic中，进入死信Topic的消息不能被再次消费。RocketMQ认为，如果17次机会都失败了，说明生产者发送消息的格式发生了变化，或者消费服务出现了问题，需要人工介入处理。</p>
<ul>
<li><p>Rebalance </p>
<p>Rebalance</p>
<p>（重平衡）机制</p>
<p>，用于在发生Broker掉线、Topic扩容和缩容、消费者扩容和缩容等变化时，自动感知并调整自身消费，以尽量减少甚至避免消息没有被消费。 触发时机</p>
<ul>
<li>Consumer启动时 启动之后会立马进行Rebalance</li>
</ul>
</li>
<li><p>Consumer运行中会监听Broker发送过来的Rebalance消息，以及Consumer自身的定时任务（每隔20s）触发的Rebalance</p>
</li>
<li><p>Consumer停止运行时没有直接的调用Rebalance，而是会通知Broker自己下线了，然后Broker会通知其余的Consumer进行Rebalance。</p>
</li>
</ul>
<p>Rebalance 核心逻辑主要在 client 侧。首先，<strong>Consumer 从 Broker 拉取自己订阅的所有 Topic 和 ConsumerGroup 下的消费者信息。然后会对 Topic 中 MessageQueue 和 消费者ID 进行排序，然后用消息队列默认分配算法来进行分配。排序是关键步骤，因为 consumer 之间并不通信，通过排序这样可以保证每一个 consumer 的视图一致，然后通过相同的分配算法，就能达到分配结果的一致。</strong> </p>
<p>常见的分配算法：</p>
<ul>
<li><strong>AllocateMessageQueueAveragely平均算法，默认策略</strong></li>
<li><strong>AllocateMessageQueueAveragelyByCircle：环形平均算法。</strong></li>
<li><strong>AllocateMessageQueueByConfig：根据配置负载均衡算法，根据配置，为每一个消费者配置固定的消息队列。</strong></li>
<li><strong>AllocateMessageQueueByMachineRoom：根据机房负载均衡算法。</strong></li>
<li><strong>AllocateMessageQueueConsistentHash：一致性哈希负载均衡算法。</strong></li>
</ul>
<blockquote>
<p>举个栗子，假设队列大小是8（编号0-7），消费者数量3（编号0-2），分配结果就是 AllocateMessageQueueAveragely的结果：</p>
</blockquote>
<blockquote>
<p>消费者0：队列0，1，2；</p>
</blockquote>
<blockquote>
<p>消费者1：队列3，4，5；</p>
</blockquote>
<blockquote>
<p>消费者2：队列6，7。</p>
</blockquote>
<blockquote>
<p>AllocateMessageQueueAveragelyByCircle的结果：</p>
</blockquote>
<blockquote>
<p>消费者0：队列0，3，6；</p>
</blockquote>
<blockquote>
<p>消费者1：队列1，4，7；</p>
</blockquote>
<blockquote>
<p>消费者2：队列2，5。</p>
</blockquote>
<h4 id="消息的顺序性"><a href="#消息的顺序性" class="headerlink" title="消息的顺序性"></a>消息的顺序性</h4><p>我们可以通过指定key的方式让相关的消息都存到一个MessageQueue中，并且这个MessageQueue中的消息一定是有序的。消费者取出来的顺序也一定是有序的，但消费者可能会有多个线程并发处理消息，因为单线程的吞吐量太低。多线程并发时可能造成乱序。</p>
<p>解决：</p>
<ul>
<li><p>一个 topic，一个 partition，一个 consumer，内部单线程消费，单线程吞吐量太低，一般不会用这个。即队列数量设置为1，且单线程消费</p>
</li>
<li><p>写 N 个内存 queue，具有相同 key 的数据都到同一个内存 queue；然后对于 N 个线程，每个线程分别消费一个内存 queue 即可，这样就能保证顺序性。</p>
</li>
</ul>
<p><img src="D:%5CHexo-Blog%5Cthemes%5Cnext%5Csource%5Cimages%5CRocketMQ%E6%B6%88%E8%B4%B9%E9%A1%BA%E5%BA%8F%E6%80%A7.jpg" alt="img"></p>
<ul>
<li>通过指定key的方式保证相关的消息都会被添加到一条队列中，但此时可能有多个消费者去队列中取消息(不是同时取)，虽然能保证消息出队顺序的FIFO，但可能因为网络等原因，消费者消费的顺序不同。            解决：监听MessageListenerOrderly类，表示顺序消费，起到的作用是：采用分段锁的思想，每个consumer在拉取对应messageQueue的消息的时候，都要实现获取对应的锁，保证了同一个consumerQueue的消息不能被并发消费，锁住的不是Broker而是某一个Queue。</li>
</ul>
<h4 id="消息幂等性"><a href="#消息幂等性" class="headerlink" title="消息幂等性"></a>消息幂等性</h4><p>需要根据具体的场景具体分析：</p>
<ul>
<li><p>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，则update </p>
</li>
<li><p>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</p>
</li>
<li><p>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，就处理，然后这个 id 写 Redis。如果消费过了，那就别处理了，保证别重复处理相同的消息即可。</p>
</li>
<li><p>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</p>
</li>
<li><p>还有一些大数据日志场景允许一定的重复消费。</p>
</li>
</ul>
<h2 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h2><p>RocketMQ的Broker采用文件系统来存储消息。</p>
<h4 id="复制和刷盘"><a href="#复制和刷盘" class="headerlink" title="复制和刷盘"></a>复制和刷盘</h4><p>复制是指Broker与Broker之间的数据同步方式，分为同步和异步两种。</p>
<ul>
<li><p>同步复制时，生产者会等待同步复制成功后，才返回生产者消息发送成功。</p>
</li>
<li><p>异步复制时，消息写入Master Broker后即为写入成功，此时系统有较低的写入延迟和较大的系统吞吐量。</p>
</li>
</ul>
<p>刷盘是指数据发送到Broker的内存（通常指PageCache）后，以何种方式持久化到磁盘。</p>
<ul>
<li><p>同步刷盘时，生产者会等待数据持久化到磁盘后，才返回生产者消息发送成功，可靠性极强。</p>
</li>
<li><p>异步刷盘时，消息写入PageCache即为写入成功，到达一定量时自动触发刷盘。此时系统有非常低的写入延迟和非常大的系统吞吐量。</p>
</li>
</ul>
<h4 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h4><p>RocketMQ 主要存储的文件包括Comitlog文件、ConsumeQueue 文件、IndexFile文件。</p>
<ul>
<li><p>CommitLog：存储消息的元数据。RocketMQ将所有主题的消息存储在同一个文件中，确保消息发送时顺序写文件，尽最大能力确保消息发送的高性能与高吞吐量。每个文件大小一般是1GB，可以通过mapedFileSizeCommitLog进行配置。</p>
</li>
<li><p>ConsumerQueue：存储消息在CommitLog的索引。由于消息中间件一般是基于消息主题的订阅机制，这样便给按照消息主题检索消息带来了极大的不便。为了提高消息消费的效率，RocketMQ引入了ConsumeQueue消息队列文件，每个消息主题包含多个消息消费队列，每一个消息队列有一个消息文件。每个消费队列其实是commitlog的一个索引，提供给消费者做拉取消息、更新位点使用。</p>
</li>
<li><p>IndexFile：IndexFile索引文件，其主要设计理念就是为了加速消息的检索性能，根据消息的属性快速从Commitlog文件中检索消息，提供了一种通过key或者时间区间来查询消息的方法。全部的文件都是按照消息key创建的Hash索引。文件名是用创建时的时间戳命名的。</p>
</li>
</ul>
<h4 id="高可用-1"><a href="#高可用-1" class="headerlink" title="高可用"></a>高可用</h4><p>主从同步</p>
<ul>
<li>4.5之前：提供Master Broker 和 Slave Broker之间的数据同步功能，以及主从切换。 当master挂了, 写入服务就不可用了，但是 slave 服务仍然提供可读服务。</li>
<li>4.5之后：引入了Dleger，使用Raft共识算法, 在master故障后自动选举新leader。</li>
</ul>
<h2 id="消息丢失、重复、积压问题"><a href="#消息丢失、重复、积压问题" class="headerlink" title="消息丢失、重复、积压问题"></a>消息丢失、重复、积压问题</h2><h3 id="消息丢失"><a href="#消息丢失" class="headerlink" title="消息丢失"></a>消息丢失</h3><p>一条MQ消息会经历三个阶段：</p>
<ul>
<li>生产阶段：Producer生产消息，然后通过网络将消息传递给MQ Broker</li>
<li>存储阶段：存储消息到MQ磁盘上</li>
<li>消费阶段：Consumer从Broker拉取消息</li>
</ul>
<p>三个阶段都可能丢失消息。</p>
<ul>
<li><p>生产阶段</p>
<p>Procuder通过网络发送消息给Broker，当Broker收到后，会返回确认响应消息给Producer，发送方式分为同步发送和异步发送。同步发送指Producer发送消息后，需要收到接受方的响应才能发送下一条消息；异步发送是指发送方发出数据后，不等接收方发回响应，接着发送下个数据包，MQ 的异步发送，需要用户实现异步发送回调接口（SendCallback），对发送失败的情况进行补偿。</p>
<p><strong>无论同步还是异步，都可能因为网络发送失败，需要设置合理的重试次数</strong>。</p>
<ul>
<li><p>存储阶段</p>
<ul>
<li><p>消息存储</p>
<p>消息的存储分为<strong>同步刷盘</strong>和<strong>异步刷盘</strong>两种方式。</p>
<p>默认情况下采取异步刷盘，消息到了Broker后会先保存在内存中，消息写入PageCache即为写入成功，到达一定量时自动触发刷盘。此时系统有非常低的写入延迟和非常大的系统吞吐量。但如果出现机器宕机的情况，消息未及时刷盘，会出现消息丢失。</p>
<p>同步刷盘时，生产者会等待数据持久化到磁盘后，才返回生产者消息发送成功，可靠性极强。</p>
</li>
<li><p>消息复制</p>
<p>集群部署时还会采用一主多从架构，为了保证消息不丢失，还需要复制到slave节点，消息复制也分为<strong>同步复制</strong>和<strong>异步复制</strong>。</p>
<p>默认情况下采取异步复制，消息写入master就算成功，可以返回确认给生产者，接着消息异步复制到slave节点。若此时master节点宕机且不可恢复，则未复制到slave的消息会丢失。</p>
<p>可以采用<strong>同步复制</strong>的方式来提高消息的可靠性，<strong>master</strong> 节点将会同步等待 <strong>slave</strong> 节点复制完成，才会返回确认响应。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>消费阶段</p>
<p>消费者从 broker 拉取消息，然后执行相应的业务逻辑。一旦执行成功，将会返回SUCCESS给 Broker。如果 Broker 未收到消费确认响应或收到其他状态，消费者下次还会再次拉取到该条消息，进行重试。这样的方式有效避免了消费者消费过程发生异常，或者消息在网络传输中丢失的情况。但可能会造成重复消费的情况，需要自己做幂等。</p>
</li>
</ul>
<h3 id="消息重复-todo（出现的原因分析）"><a href="#消息重复-todo（出现的原因分析）" class="headerlink" title="消息重复 todo（出现的原因分析）"></a>消息重复 todo（出现的原因分析）</h3><p>  消费端业务自己保证幂等性。</p>
<h3 id="消息积压"><a href="#消息积压" class="headerlink" title="消息积压"></a>消息积压</h3><p>解决方案：</p>
<ol>
<li><p>全部丢弃</p>
<p>如果这些消息允许丢失，那么此时可以紧急修改消费者系统的代码，在代码里对所有的消息都获取到就直接丢弃，不做任何的处理，这样可以迅速的让积压在MQ里的百万消息被处理掉。</p>
</li>
<li><p>排查消费者系统问题</p>
<p>修复consumer，恢复消费速度</p>
</li>
<li><p>扩容消费者</p>
<p>新建一个topic，partition设为原来10倍，写一个消费程序读取积压数据，分发到新建的partition中，然后部署10倍的consumer机器消费数据。</p>
<p>消息正常后恢复原来的架构。</p>
</li>
<li><p>MQ快写满时，丢弃消息，快速消费所有的消息，后续进行补数据。</p>
</li>
</ol>
<p>解决思路：</p>
<ol>
<li>提高消费并行度</li>
<li>批量消费</li>
<li>跳过非重要消息</li>
<li>优化每条消息的消费过程</li>
</ol>
<h2 id="RocketMQ高可用"><a href="#RocketMQ高可用" class="headerlink" title="RocketMQ高可用"></a>RocketMQ高可用</h2><h3 id="消息消费高可用"><a href="#消息消费高可用" class="headerlink" title="消息消费高可用"></a>消息消费高可用</h3><p>当master不可用时，Consumer会自动切换到从slave读。</p>
<p>对于顺序消息，当Consumer消费消息失败后，RocketMQ会不断进行消息重试，此时后续消息会被阻塞。</p>
<p>RocketMQ默认每条消息会被重试16次，超过16次则不再重试，会将消息放到死信队列。</p>
<h3 id="消息发送高可用"><a href="#消息发送高可用" class="headerlink" title="消息发送高可用"></a>消息发送高可用</h3><p>NameServer检测Broker有延迟，NameServer 为了简化和客户端通信，发现 Broker 故障时并不会立即通知客户端。</p>
<ol>
<li><p>消息发送失败重试</p>
<p>在消息发送出现异常时会尝试再次发送，默认最多重试三次。重试机制仅支持同步发送方式，不支持异步和单向发送方式。</p>
</li>
<li><p>多partition</p>
<p>创建Topic时，可以把Topic下的多个partition分散到多个Broker上，这样当一个Broker不可用时不会影响其他的partition。</p>
</li>
<li><p>主从切换</p>
<p>master不可用时，自动进行主从切换</p>
</li>
</ol>
<h3 id="消息主从复制"><a href="#消息主从复制" class="headerlink" title="消息主从复制"></a>消息主从复制</h3><p>同步刷盘、异步刷盘</p>
<p>同步复制、异步复制</p>
<h2 id="Rebalance"><a href="#Rebalance" class="headerlink" title="Rebalance"></a>Rebalance</h2><p>Rebalance用于Consumer Group下的消费者达成一致来分配Queue。当Consumer订阅的Topic发生变化或者Consumer实例发生变化后会触发Rebalance来重新分配每个消费者实例对应的Queue。</p>
<ol>
<li><p>轮询实例订阅的所有Topic</p>
</li>
<li><p>基于topic调用rebalanceByTopic执行rebalance</p>
</li>
<li><p>分为广播模式和集群模式。</p>
<ol>
<li><p>广播模式</p>
<p>获取该topic下的所有Queue，每个客户端都能收到topic下的所有Queue,为客户端分配的Queue集合为全量的集合。</p>
</li>
<li><p>集群模式</p>
<p>获取topic下的所有Queue；从broker获取该topic下所有客户端id列表；排序后调用AllocateMessageAueueStrategy获得ConsumerGroup下该客户端应该分配到的Queue集合，默认平均分配。即集群模式下，每个客户端分到的Queue列表由AllocateMessageQueueStrategy来分配。</p>
<p>默认平均策略执行时，会把Queue列表和客户端id进行排序，分配时排在前面的客户端能分到Queue的会多一点。因而在初始化时，最好保证ConsumerGroup下的客户端数量&lt;=Topic下的Queue数量。</p>
</li>
</ol>
</li>
<li><p>获取该客户端所属的Queue集合后，调用updateProcessQueueTableInRebalance更新，更新当前客户端处理的Queue以及对应的消费进度。</p>
</li>
<li><p>调用truncateMessageQueueNotMyTopic移除缓存中不是该实例处理的Queue</p>
</li>
</ol>
<p>上面的Rebalance都是客户端自己定时(默认20s)执行的，还可以Broker进行主动通知。Broker有一个ConsumerManager，当客户端实例发生变更时(上下线)会通知到各个客户端执行Rebalance。</p>
<p>RocketMQ和Kafka Rebalance对比：</p>
<ol>
<li>Kafka：会在消费者组的多个消费者实例中，选出一个作为Group Leader，由这个Group Leader来进行分区分配，分配结果通过Cordinator(特殊角色的broker)同步给其他消费者。相当于Kafka的分区分配只有一个大脑，就是Group Leader。</li>
<li>RocketMQ：每个消费者，自己负责给自己分配队列，相当于每个消费者都是一个大脑。</li>
</ol>
<p>Rebalance缺陷：</p>
<ol>
<li><p>消费暂停</p>
<p>新增Consumer后出发Rebalance需要分配Queue给新Consumer，在此期间分配的Consumer无法被消费。</p>
</li>
<li><p>重复消费</p>
<p>新增的Consumer拿到分配的Queue后，必须从之前的Consumer已经消费过的offset继续消费，但offset的提交默认是异步的，当offset未提交时发生了Rebalance，就会导致重复消费。</p>
</li>
<li><p>消费突刺</p>
<p>rebalance导致重复消费，重复消费的消息过多，或者rebalance暂停时间过长导致积压消息，造成消费的突刺。</p>
</li>
</ol>

      
    </div>
    
    
    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>


    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RocketMQ/" rel="tag"><i class="fa fa-tag"></i>RocketMQ</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/11/04/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="next" title="秒杀系统设计">
                <i class="fa fa-chevron-left"></i> 秒杀系统设计
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/05/18/Golang-sync-Mutex%E4%BA%92%E6%96%A5%E9%94%81%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" rel="prev" title="Golang sync.Mutex互斥锁原理解析">
                Golang sync.Mutex互斥锁原理解析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">flbu</p>
              <p class="site-description motion-element" itemprop="description">flbu的技术博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/f1bu920" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:bufeilong823920@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#消息队列学习笔记–RocketMQ"><span class="nav-text">消息队列学习笔记–RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#消息队列的优缺点"><span class="nav-text">消息队列的优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优点"><span class="nav-text">优点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#异步"><span class="nav-text">异步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#削峰填谷"><span class="nav-text">削峰填谷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解耦"><span class="nav-text">解耦</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缺点"><span class="nav-text">缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#系统可用性降低"><span class="nav-text">系统可用性降低</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#系统复杂度提高"><span class="nav-text">系统复杂度提高</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据一致性问题"><span class="nav-text">数据一致性问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息队列选型"><span class="nav-text">消息队列选型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocketMQ整体架构"><span class="nav-text">RocketMQ整体架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Topic"><span class="nav-text">Topic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NameServer"><span class="nav-text">NameServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注册发现"><span class="nav-text">注册发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由剔除"><span class="nav-text">路由剔除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Producer"><span class="nav-text">Producer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发送方式"><span class="nav-text">消息发送方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#可靠同步发送"><span class="nav-text">可靠同步发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可靠异步发送"><span class="nav-text">可靠异步发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单向发送"><span class="nav-text">单向发送</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息类型"><span class="nav-text">消息类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#普通消息"><span class="nav-text">普通消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#延迟消息"><span class="nav-text">延迟消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务消息"><span class="nav-text">事务消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#顺序消息"><span class="nav-text">顺序消息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送流程"><span class="nav-text">发送流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consumer"><span class="nav-text">Consumer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#消费模式"><span class="nav-text">消费模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拉取流程"><span class="nav-text">拉取流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消费进度保存"><span class="nav-text">消费进度保存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用"><span class="nav-text">高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息的顺序性"><span class="nav-text">消息的顺序性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息幂等性"><span class="nav-text">消息幂等性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Broker"><span class="nav-text">Broker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#复制和刷盘"><span class="nav-text">复制和刷盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#存储"><span class="nav-text">存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用-1"><span class="nav-text">高可用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息丢失、重复、积压问题"><span class="nav-text">消息丢失、重复、积压问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息丢失"><span class="nav-text">消息丢失</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息重复-todo（出现的原因分析）"><span class="nav-text">消息重复 todo（出现的原因分析）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息积压"><span class="nav-text">消息积压</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocketMQ高可用"><span class="nav-text">RocketMQ高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息消费高可用"><span class="nav-text">消息消费高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发送高可用"><span class="nav-text">消息发送高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息主从复制"><span class="nav-text">消息主从复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rebalance"><span class="nav-text">Rebalance</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">flbu</span>

  
</div>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    本站总访问量<span id="busuanzi_value_site_uv"></span>次
</span>
</div>
<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>

-->


        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
